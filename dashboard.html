<!DOCTYPE html>
<html>
<head>
  <title>URL Shortener Dashboard</title>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!--
        <link rel="icon" href="/favicon.png">
        
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
  
  
  -->

  <link rel="stylesheet" href="https://unpkg.com/wingcss@1.0.0-beta/dist/wing.min.css" />


  <style type="text/css">
    @import url(https://fonts.googleapis.com/css?family=Roboto:300);

    body {
      text-align: center;
      background: #76b852;
      /* fallback for old browsers */
      background: -webkit-linear-gradient(right, #76b852, #8DC26F);
      background: -moz-linear-gradient(right, #76b852, #8DC26F);
      background: -o-linear-gradient(right, #76b852, #8DC26F);
      background: linear-gradient(to left, #76b852, #8DC26F);
      font-family: "Roboto", sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    input[type=text] {
      max-width: 350px;
    }

    h4 {
      color: #3d3d3d;
    }

    a {
      color: inherit;
    }
  </style>
</head>

<body>
  <div class="container">

    <h1>Dashboard</h1>
    <h3>Shorten your URL</h3>

    <form onsubmit="shorten(event)">
      <input id="url" type="text" placeholder=" Paste the long link" required>
      <br>
      <!--
          <input id="key" type="text" placeholder=" A custom path? (optional)">
          -->
      <br>
      <button class="outline">Shorten </button>
    </form>

    <br><br>

    <h4></h4>

    <br>
    <button class="outline" onClick="getURLsForUser(event)">View your URLs </button>

    <!--
    <script type="text/javascript" src="scriptdashboard.js"></script>
      -->
    <div class="row">
      <div class="table-responsive table-bordered movie-table">
        <table class="table movie-table">
          <thead>
            <tr class="movie-table-head">
              <th>Short URL</th>
              <th>Long URL</th>
              <th>Times Visited</th>
              <th>User</th>
            </tr>
          </thead>
          <tbody id="URLsTableTbody">

            <!--
            <tr class="dark-row">
              <td>short1</td>
              <td>long2 </td>
              <td>0</td>
              <td>something</td>
            </tr>

            <tr class="light-row">
              <td>short2</td>
              <td>long2</td>
              <td>0</td>
              <td>something</td>
            </tr>
          -->

          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    async function shorten(e) {

      e.preventDefault();
      console.log("Shortening the url")
      var url = document.querySelector("#url").value;
      var key;
      //key = document.querySelector("#key").value;

      if (key == "" || key == undefined) {
        key = Math.random().toString(36).substr(2, 5);
      }

      let currentUserEmail = localStorage.getItem('currentUserEmail');

      let shorten = await fetch('https://url-shortener-umesh.herokuapp.com/shorten', {
        method: "POST",
        mode: 'cors',
        body: JSON.stringify({
          "shortURL": "https://url-shortener-umesh.herokuapp.com/" + key,
          "longURL": url,
          "currentUserEmail": currentUserEmail
        }),
        headers: {
          "Content-Type": "application/json",
        },
      });

      document.querySelector("h4").innerHTML = `Shortened URL is <a href="https://url-shortener-umesh.herokuapp.com/${key}">url-shortener-umesh.herokuapp.com/${key}</a>`;
    }

    async function getURLsForUser(e) {

      console.log("Getting the urls of the user")

      let currentUserEmail = localStorage.getItem('currentUserEmail');

      let getURLs = await fetch('https://url-shortener-umesh.herokuapp.com/getURLs/' + currentUserEmail);
      let URLData = await getURLs.json();

      let tbody = document.getElementById("URLsTableTbody");
      tbody.innerHTML = "";

      URLData.forEach((eachURL) => {
        let tr = document.createElement("tr");

        let td1 = document.createElement("td");
        td1.innerHTML = eachURL.shortURL;
        let td2 = document.createElement("td");
        td2.innerHTML = eachURL.longURL;
        let td3 = document.createElement("td");
        td3.innerHTML = eachURL.timesClicked;
        let td4 = document.createElement("td");
        td4.innerHTML = eachURL.user;

        tr.appendChild(td1);
        tr.appendChild(td2);
        tr.appendChild(td3);
        tr.appendChild(td4);

        tbody.appendChild(tr);
      });
    }
  </script>
</body>

</html>